"use strict";
var core_1 = require("@angular/core");
var base_component_1 = require("../base.component");
var index_1 = require("../../index");
var BoardComponent = (function (_super) {
    __extends(BoardComponent, _super);
    function BoardComponent() {
        var _this = _super.call(this) || this;
        _this.rows = [];
        _this._emptySquare = null;
        return _this;
    }
    Object.defineProperty(BoardComponent.prototype, "database", {
        get: function () {
            var stateService = this.options &&
                this.options.hasOwnProperty('stateService') ? this.options.stateService : null;
            return stateService ? stateService.databaseService : null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BoardComponent.prototype, "emptySquare", {
        get: function () {
            var emptyRow = this.rows.filter(function (row) {
                return row.hasOwnProperty('emptySquare') && row.emptySquare !== null;
            }), initEmptySquare = emptyRow && emptyRow.length ? emptyRow[0].emptySquare : null;
            if (this._emptySquare) {
                return this._emptySquare;
            }
            return initEmptySquare;
        },
        set: function (value) {
            this._emptySquare = value;
        },
        enumerable: true,
        configurable: true
    });
    BoardComponent.prototype.ngOnChanges = function (changes) {
        var _this = this;
        if (this.options) {
            if (!this.options.hasOwnProperty('isSolved')) {
                this.options.isSolved = false;
            }
            if (!this.options.hasOwnProperty('sequence')) {
                this.options.sequence = this.sequence(this.options);
            }
            if (!this.options.hasOwnProperty('expectedSequence')) {
                this.options.expectedSequence = this.sequence(this.options, true);
            }
            this.rows = this.transform(this.options);
            if (this.subscriptions.length === 0) {
                if (this.options.actionService) {
                    this.subscriptions.push(this.options.actionService.actionChange$
                        .subscribe(function (action) { return _this.onActionChange(action); }));
                }
            }
        }
    };
    BoardComponent.prototype.onRowSquareClick = function ($event) {
        var row = $event[0], a = $event[1], b = this.emptySquare ? this.emptySquare : null;
        if (row && a && b) {
            if (!a.isEmpty && index_1.Utils.isValidMove(a, b)) {
                index_1.Utils.swap(a, b);
                this.persist(a);
                this.persist(b);
                this.emptySquare = a;
            }
        }
    };
    BoardComponent.prototype.onRowLeftClick = function (row) {
        if (row.emptySquare !== null) {
            this.emptySquare = row.emptySquare;
        }
    };
    BoardComponent.prototype.onRowRightClick = function (row) {
        if (row.emptySquare !== null) {
            this.emptySquare = row.emptySquare;
        }
    };
    BoardComponent.prototype.onActionChange = function (action) {
        var _this = this;
        this.unPersist();
        switch (action) {
            case index_1.ActionsEnum.PLAY:
                this.options.isSolved = false;
                break;
            case index_1.ActionsEnum.SOLVE:
                this.options.isSolved = true;
                break;
        }
        setTimeout(function () {
            _this.rows = _this.transform(_this.options);
        }, 100);
    };
    BoardComponent.prototype.sequence = function (options, expect) {
        if (expect === void 0) { expect = false; }
        var min = 1, rows = options ? options.rows : null, cols = rows ? options.cols : null, max = rows && cols ? rows * cols : 0, seq = [];
        if (max > 0) {
            if (!expect) {
                seq = index_1.Utils.generateSequence(min, max, max);
            }
            else {
                seq = index_1.Utils.generateSequentialSequence(min, max);
            }
        }
        return seq;
    };
    BoardComponent.prototype.transform = function (options) {
        var row = 1, i = 1, pos = 0, rows = options.rows, cols = options.cols, isSolved = options.isSolved, seq = options.sequence, expectedSeq = options.expectedSequence, subSeq = [], expectedSubSeq = [], store = [], stateService = options.stateService;
        for (; row <= rows; row++) {
            if (isSolved) {
                subSeq = index_1.Utils.parseSubSequence(expectedSeq, pos, cols);
            }
            else {
                subSeq = index_1.Utils.parseSubSequence(seq, pos, cols);
            }
            expectedSubSeq = index_1.Utils.parseSubSequence(expectedSeq, pos, cols);
            store.push({
                index: i,
                isLast: row === rows ? true : false,
                sequence: subSeq,
                expectedSequence: expectedSubSeq,
                stateService: stateService
            });
            i++;
            pos += cols;
        }
        return store;
    };
    BoardComponent.prototype.unPersist = function () {
        var databaseService = this.database;
        if (databaseService) {
            databaseService.zero('row');
        }
    };
    BoardComponent.prototype.persist = function (options) {
        var databaseService = this.database;
        if (databaseService) {
            databaseService.push(options.id, options);
        }
    };
    return BoardComponent;
}(base_component_1.BaseComponent));
__decorate([
    core_1.Input(),
    __metadata("design:type", Object)
], BoardComponent.prototype, "options", void 0);
BoardComponent = __decorate([
    core_1.Component({
        moduleId: module.id,
        selector: 'pz-board',
        templateUrl: 'board.component.html',
        styleUrls: [
            'board.component.css',
        ],
    }),
    __metadata("design:paramtypes", [])
], BoardComponent);
exports.BoardComponent = BoardComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9hcmQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYm9hcmQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxzQ0FBeUU7QUFXekUsb0RBQWdEO0FBR2hELHFDQUErQztBQVcvQyxJQUFhLGNBQWM7SUFBUyxrQ0FBYTtJQThCL0M7UUFBQSxZQUNFLGlCQUFPLFNBR1I7UUFGQyxLQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNmLEtBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDOztJQUMzQixDQUFDO0lBMUJELHNCQUFJLG9DQUFRO2FBQVo7WUFDRSxJQUFJLFlBQVksR0FBMEIsSUFBSSxDQUFDLE9BQU87Z0JBQ3RELElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztZQUMvRSxNQUFNLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1FBQzVELENBQUM7OztPQUFBO0lBRUQsc0JBQUksdUNBQVc7YUFBZjtZQUNFLElBQUksUUFBUSxHQUEwQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFDLEdBQXdCO2dCQUM1RSxNQUFNLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsSUFBSSxHQUFHLENBQUMsV0FBVyxLQUFLLElBQUksQ0FBQztZQUN2RSxDQUFDLENBQUMsRUFDRixlQUFlLEdBQTJCLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1lBRXpHLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO2dCQUN0QixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQztZQUMzQixDQUFDO1lBQ0QsTUFBTSxDQUFD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QUFFO1lBQ1QscUJBQXFCO1NBQ3RCO0tBQ0YsQ0FBQzs7R0FDVyxjQUFjLENBOEsxQjtBQTlLWSx3Q0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBJbnB1dCwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtcbiAgUm93T3B0aW9uc0ludGVyZmFjZSxcbiAgUm93Q29tcG9uZW50LCBTcXVhcmVPcHRpb25zSW50ZXJmYWNlXG59IGZyb20gJy4uL2luZGV4JztcbmltcG9ydCB7XG4gIFN0YXRlU2VydmljZUludGVyZmFjZSxcbiAgRGF0YWJhc2VTZXJ2aWNlSW50ZXJmYWNlXG59IGZyb20gJy4uLy4uL2luZGV4JztcblxuaW1wb3J0IHtCYXNlQ29tcG9uZW50fSBmcm9tICcuLi9iYXNlLmNvbXBvbmVudCc7XG5pbXBvcnQge0JvYXJkSW50ZXJmYWNlfSBmcm9tICcuL2JvYXJkLmludGVyZmFjZSc7XG5pbXBvcnQge0JvYXJkT3B0aW9uc0ludGVyZmFjZX0gZnJvbSAnLi9ib2FyZC1vcHRpb25zLmludGVyZmFjZSc7XG5pbXBvcnQge1V0aWxzLCBBY3Rpb25zRW51bX0gZnJvbSAnLi4vLi4vaW5kZXgnO1xuXG5cbkBDb21wb25lbnQoe1xuICBtb2R1bGVJZDogbW9kdWxlLmlkLFxuICBzZWxlY3RvcjogJ3B6LWJvYXJkJyxcbiAgdGVtcGxhdGVVcmw6ICdib2FyZC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogW1xuICAgICdib2FyZC5jb21wb25lbnQuY3NzJyxcbiAgXSxcbn0pXG5leHBvcnQgY2xhc3MgQm9hcmRDb21wb25lbnQgZXh0ZW5kcyBCYXNlQ29tcG9uZW50IGltcGxlbWVudHMgQm9hcmRJbnRlcmZhY2UsIE9uQ2hhbmdlcyB7XG5cbiAgQElucHV0KCkgb3B0aW9uczogQm9hcmRPcHRpb25zSW50ZXJmYWNlO1xuXG4gIHJvd3M6IFJvd09wdGlvbnNJbnRlcmZhY2VbXTtcblxuICBwcml2YXRlIF9lbXB0eVNxdWFyZTogU3F1YXJlT3B0aW9uc0ludGVyZmFjZTtcblxuICBnZXQgZGF0YWJhc2UoKTogRGF0YWJhc2VTZXJ2aWNlSW50ZXJmYWNlIHtcbiAgICBsZXQgc3RhdGVTZXJ2aWNlOiBTdGF0ZVNlcnZpY2VJbnRlcmZhY2UgPSB0aGlzLm9wdGlvbnMgJiZcbiAgICB0aGlzLm9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ3N0YXRlU2VydmljZScpID8gdGhpcy5vcHRpb25zLnN0YXRlU2VydmljZSA6IG51bGw7XG4gICAgcmV0dXJuIHN0YXRlU2VydmljZSA/IHN0YXRlU2VydmljZS5kYXRhYmFzZVNlcnZpY2UgOiBudWxsO1xuICB9XG5cbiAgZ2V0IGVtcHR5U3F1YXJlKCk6IFNxdWFyZU9wdGlvbnNJbnRlcmZhY2Uge1xuICAgIGxldCBlbXB0eVJvdzogUm93T3B0aW9uc0ludGVyZmFjZVtdID0gdGhpcy5yb3dzLmZpbHRlcigocm93OiBSb3dPcHRpb25zSW50ZXJmYWNlKSA9PiB7XG4gICAgICAgIHJldHVybiByb3cuaGFzT3duUHJvcGVydHkoJ2VtcHR5U3F1YXJlJykgJiYgcm93LmVtcHR5U3F1YXJlICE9PSBudWxsO1xuICAgICAgfSksXG4gICAgICBpbml0RW1wdHlTcXVhcmU6IFNxdWFyZU9wdGlvbnNJbnRlcmZhY2UgPSBlbXB0eVJvdyAmJiBlbXB0eVJvdy5sZW5ndGggPyBlbXB0eVJvd1swXS5lbXB0eVNxdWFyZSA6IG51bGw7XG5cbiAgICBpZiAodGhpcy5fZW1wdHlTcXVhcmUpIHtcbiAgICAgIHJldHVybiB0aGlzLl9lbXB0eVNxdWFyZTtcbiAgICB9XG4gICAgcmV0dXJuIGluaXRFbXB0eVNxdWFyZTtcbiAgfVxuXG4gIHNldCBlbXB0eVNxdWFyZSh2YWx1ZTogU3F1YXJlT3B0aW9uc0ludGVyZmFjZSkge1xuICAgIHRoaXMuX2VtcHR5U3F1YXJlID0gdmFsdWU7XG4gIH1cblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMucm93cyA9IFtdO1xuICAgIHRoaXMuX2VtcHR5U3F1YXJlID0gbnVsbDtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5vcHRpb25zKSB7XG4gICAgICBpZiAoIXRoaXMub3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnaXNTb2x2ZWQnKSkge1xuICAgICAgICB0aGlzLm9wdGlvbnMuaXNTb2x2ZWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5vcHRpb25zLmhhc093blByb3BlcnR5KCdzZXF1ZW5jZScpKSB7XG4gICAgICAgIHRoaXMub3B0aW9ucy5zZXF1ZW5jZSA9IHRoaXMuc2VxdWVuY2UodGhpcy5vcHRpb25zKTtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5vcHRpb25zLmhhc093blByb3BlcnR5KCdleHBlY3RlZFNlcXVlbmNlJykpIHtcbiAgICAgICAgdGhpcy5vcHRpb25zLmV4cGVjdGVkU2VxdWVuY2UgPSB0aGlzLnNlcXVlbmNlKHRoaXMub3B0aW9ucywgdHJ1ZSk7XG4gICAgICB9XG4gICAgICB0aGlzLnJvd3MgPSB0aGlzLnRyYW5zZm9ybSh0aGlzLm9wdGlvbnMpO1xuICAgICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5hY3Rpb25TZXJ2aWNlKSB7XG4gICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2godGhpcy5vcHRpb25zLmFjdGlvblNlcnZpY2UuYWN0aW9uQ2hhbmdlJFxuICAgICAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgKGFjdGlvbjogYW55KSA9PiB0aGlzLm9uQWN0aW9uQ2hhbmdlKGFjdGlvbilcbiAgICAgICAgICAgICkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgb25Sb3dTcXVhcmVDbGljaygkZXZlbnQ6IGFueSk6IHZvaWQge1xuICAgIGxldCByb3c6IFJvd0NvbXBvbmVudCA9ICRldmVudFswXSxcbiAgICAgIGE6IFNxdWFyZU9wdGlvbnNJbnRlcmZhY2UgPSAkZXZlbnRbMV0sXG4gICAgICBiOiBTcXVhcmVPcHRpb25zSW50ZXJmYWNlID0gdGhpcy5lbXB0eVNxdWFyZSA/IHRoaXMuZW1wdHlTcXVhcmUgOiBudWxsO1xuICAgIGlmIChyb3cgJiYgYSAmJiBiKSB7XG4gICAgICBpZiAoIWEuaXNFbXB0eSAmJiBVdGlscy5pc1ZhbGlkTW92ZShhLCBiKSkge1xuICAgICAgICBVdGlscy5zd2FwKGEsIGIpO1xuICAgICAgICB0aGlzLnBlcnNpc3QoYSk7XG4gICAgICAgIHRoaXMucGVyc2lzdChiKTtcbiAgICAgICAgdGhpcy5lbXB0eVNxdWFyZSA9IGE7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgb25Sb3dMZWZ0Q2xpY2socm93OiBSb3dDb21wb25lbnQpOiB2b2lkIHtcbiAgICBpZiAocm93LmVtcHR5U3F1YXJlICE9PSBudWxsKSB7XG4gICAgICB0aGlzLmVtcHR5U3F1YXJlID0gcm93LmVtcHR5U3F1YXJlO1xuICAgIH1cbiAgfVxuXG4gIG9uUm93UmlnaHRDbGljayhyb3c6IFJvd0NvbXBvbmVudCk6IHZvaWQge1xuICAgIGlmIChyb3cuZW1wdHlTcXVhcmUgIT09IG51bGwpIHtcbiAgICAgIHRoaXMuZW1wdHlTcXVhcmUgPSByb3cuZW1wdHlTcXVhcmU7XG4gICAgfVxuICB9XG5cbiAgb25BY3Rpb25DaGFuZ2UoYWN0aW9uOiBBY3Rpb25zRW51bSk6IHZvaWQge1xuICAgIHRoaXMudW5QZXJzaXN0KCk7XG5cbiAgICBzd2l0Y2ggKGFjdGlvbikge1xuICAgICAgY2FzZSBBY3Rpb25zRW51bS5QTEFZOlxuICAgICAgICB0aGlzLm9wdGlvbnMuaXNTb2x2ZWQgPSBmYWxzZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEFjdGlvbnNFbnVtLlNPTFZFOlxuICAgICAgICB0aGlzLm9wdGlvbnMuaXNTb2x2ZWQgPSB0cnVlO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLnJvd3MgPSB0aGlzLnRyYW5zZm9ybSh0aGlzLm9wdGlvbnMpO1xuICAgIH0sIDEwMCk7XG5cbiAgfVxuXG4gIHNlcXVlbmNlKG9wdGlvbnM6IEJvYXJkT3B0aW9uc0ludGVyZmFjZSwgZXhwZWN0OiBib29sZWFuID0gZmFsc2UpOiBudW1iZXJbXSB7XG4gICAgbGV0IG1pbjogbnVtYmVyID0gMSxcbiAgICAgIHJvd3M6IG51bWJlciA9IG9wdGlvbnMgPyBvcHRpb25zLnJvd3MgOiBudWxsLFxuICAgICAgY29sczogbnVtYmVyID0gcm93cyA/IG9wdGlvbnMuY29scyA6IG51bGwsXG4gICAgICBtYXg6IG51bWJlciA9IHJvd3MgJiYgY29scyA/IHJvd3MgKiBjb2xzIDogMCxcbiAgICAgIHNlcTogbnVtYmVyW10gPSBbXTtcblxuICAgIGlmIChtYXggPiAwKSB7XG4gICAgICBpZiAoIWV4cGVjdCkge1xuICAgICAgICBzZXEgPSBVdGlscy5nZW5lcmF0ZVNlcXVlbmNlKG1pbiwgbWF4LCBtYXgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2VxID0gVXRpbHMuZ2VuZXJhdGVTZXF1ZW50aWFsU2VxdWVuY2UobWluLCBtYXgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBzZXE7XG5cbiAgfVxuXG4gIHRyYW5zZm9ybShvcHRpb25zOiBCb2FyZE9wdGlvbnNJbnRlcmZhY2UpOiBSb3dPcHRpb25zSW50ZXJmYWNlW10ge1xuICAgIGxldCByb3c6IG51bWJlciA9IDEsXG4gICAgICBpOiBudW1iZXIgPSAxLFxuICAgICAgcG9zOiBudW1iZXIgPSAwLFxuICAgICAgcm93czogbnVtYmVyID0gb3B0aW9ucy5yb3dzLFxuICAgICAgY29sczogbnVtYmVyID0gb3B0aW9ucy5jb2xzLFxuICAgICAgaXNTb2x2ZWQ6IGJvb2xlYW4gPSBvcHRpb25zLmlzU29sdmVkLFxuICAgICAgc2VxOiBudW1iZXJbXSA9IG9wdGlvbnMuc2VxdWVuY2UsXG4gICAgICBleHBlY3RlZFNlcTogbnVtYmVyW10gPSBvcHRpb25zLmV4cGVjdGVkU2VxdWVuY2UsXG4gICAgICBzdWJTZXE6IG51bWJlcltdID0gW10sXG4gICAgICBleHBlY3RlZFN1YlNlcTogbnVtYmVyW10gPSBbXSxcbiAgICAgIHN0b3JlOiBSb3dPcHRpb25zSW50ZXJmYWNlW10gPSBbXSxcbiAgICAgIHN0YXRlU2VydmljZTogU3RhdGVTZXJ2aWNlSW50ZXJmYWNlID0gb3B0aW9ucy5zdGF0ZVNlcnZpY2U7XG5cbiAgICBmb3IgKDsgcm93IDw9IHJvd3M7IHJvdysrKSB7XG4gICAgICBpZiAoaXNTb2x2ZWQpIHtcbiAgICAgICAgc3ViU2VxID0gVXRpbHMucGFyc2VTdWJTZXF1ZW5jZShleHBlY3RlZFNlcSwgcG9zLCBjb2xzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN1YlNlcSA9IFV0aWxzLnBhcnNlU3ViU2VxdWVuY2Uoc2VxLCBwb3MsIGNvbHMpO1xuICAgICAgfVxuICAgICAgZXhwZWN0ZWRTdWJTZXEgPSBVdGlscy5wYXJzZVN1YlNlcXVlbmNlKGV4cGVjdGVkU2VxLCBwb3MsIGNvbHMpO1xuXG4gICAgICBzdG9yZS5wdXNoKDxSb3dPcHRpb25zSW50ZXJmYWNlPntcbiAgICAgICAgaW5kZXg6IGksXG4gICAgICAgIGlzTGFzdDogcm93ID09PSByb3dzID8gdHJ1ZSA6IGZhbHNlLFxuICAgICAgICBzZXF1ZW5jZTogc3ViU2VxLFxuICAgICAgICBleHBlY3RlZFNlcXVlbmNlOiBleHBlY3RlZFN1YlNlcSxcbiAgICAgICAgc3RhdGVTZXJ2aWNlOiBzdGF0ZVNlcnZpY2VcbiAgICAgIH0pO1xuICAgICAgaSsrO1xuICAgICAgcG9zICs9IGNvbHM7XG4gICAgfVxuXG5cbiAgICByZXR1cm4gc3RvcmU7XG4gIH1cblxuICB1blBlcnNpc3QoKTogdm9pZCB7XG4gICAgbGV0IGRhdGFiYXNlU2VydmljZTogRGF0YWJhc2VTZXJ2aWNlSW50ZXJmYWNlID0gdGhpcy5kYXRhYmFzZTtcblxuICAgIGlmIChkYXRhYmFzZVNlcnZpY2UpIHtcbiAgICAgIGRhdGFiYXNlU2VydmljZS56ZXJvKCdyb3cnKTtcbiAgICB9XG4gIH1cblxuICBwZXJzaXN0KG9wdGlvbnM6IFNxdWFyZU9wdGlvbnNJbnRlcmZhY2UpOiB2b2lkIHtcbiAgICBsZXQgZGF0YWJhc2VTZXJ2aWNlOiBEYXRhYmFzZVNlcnZpY2VJbnRlcmZhY2UgPSB0aGlzLmRhdGFiYXNlO1xuXG4gICAgaWYgKGRhdGFiYXNlU2VydmljZSkge1xuICAgICAgZGF0YWJhc2VTZXJ2aWNlLnB1c2gob3B0aW9ucy5pZCwgb3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==